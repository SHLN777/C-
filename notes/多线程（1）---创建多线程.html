<html>
<head>
  <title>多线程（1）---创建多线程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="743"/>
<h1>多线程（1）---创建多线程</h1>

<div>
<span><div><span style="font-size: 12pt;">C++11新标准线程库</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">以往：不能跨平台</font></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">Windows：CreateThread() , _beginthred() , _beginthredexe() 创建线程</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">Linux：pthtread_create()创建线程</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">C++11：增加对多线程的支持，跨平台</span></div></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">void myprint()</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;&quot;guu&quot;&lt;&lt;endl;</font></div><div><font style="font-size: 12pt;">}</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#AD0000" style="font-size: 14pt;"><b>#include &lt;thread&gt;</b></font></div><div><font color="#AD0000" style="font-size: 14pt;"><b><br/></b></font></div><div><font style="font-size: 12pt;">int main()</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">//程序运行起来，生成一个进程，该进程所属的主线程开始自动运行</font></div><div><font style="font-size: 12pt;">//整个进程是否执行完毕的标志是：该进程的主线程是否执行完</font></div><div><font style="font-size: 12pt;">cout&lt;&lt;&quot;guu&quot;&lt;&lt;endl; //<font color="#E30000">实际上这个是主线程执行，主线程从main()函数返回，则整个进程执行完毕</font></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font color="#147191" style="font-size: 12pt;">//主线程从main()函数开始，我们自己创建的线程也要从一个函数开始运行</font></div><div><font color="#147191" style="font-size: 12pt;">//a)包含一个头文件thread</font></div><div><font color="#147191" style="font-size: 12pt;">//b)初试函数要写</font></div><div><font color="#147191" style="font-size: 12pt;">//c)main中开始写代码</font></div><div><font color="#000000" style="font-size: 12pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（1.1）thread：是个标准库里的类</b></font></div><div><span style="background-color: rgb(255, 250, 165);font-size: 12pt;color: rgb(51, 51, 51);font-family: Monaco;-evernote-highlight:true;"><b>（1.2）join()</b></span></div><div><font style="font-size: 12pt;">thread myxch(myprint);//创建一个线程对象</font></div><div><font style="font-size: 12pt;">myxch.join();//主线程阻塞到这里等待myprint()执行完</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;color: rgb(51, 51, 51);font-family: Monaco;background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（1.3）detach()：分离，主线程不和子线程汇合，可以各执行各的</b></span></div><div><font style="font-size: 12pt;">thread myxch(myprint);</font></div><div><font style="font-size: 12pt;">myxch.detach(); //一旦detach()之后，与这个主线程关联的thread对象</font></div><div><font style="font-size: 12pt;">                    就会失去与这个主线程的关联，此时这个子线程就会</font></div><div><font style="font-size: 12pt;">                    驻留在后台运行（<b>守护线程</b>），这个子线程就相当于</font></div><div><font style="font-size: 12pt;">                    被C++运行时库接管了，</font><span style="font-size: 12pt;">当这个子线程执行完毕后，</span></div><div><span style="font-size: 12pt;">                    由运行时库负责清理线程相关的资源。</span></div><div><br/></div><div><font style="font-size: 12pt;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（1.4）joinable()：判断是否可以成功使用join()或者detach()</b></span></font></div><div><font style="font-size: 12pt;">thread myxch(myprint);</font></div><div><font style="font-size: 12pt;">if(myxch.joinable())</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    //cout&lt;&lt;&quot;true&quot;&lt;&lt;endl;</font></div><div><font style="font-size: 12pt;">    myxch.join();</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">else</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;&quot;false&quot;&lt;&lt;endl;</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">return 0</font></div><div><font style="font-size: 12pt;">}</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(51, 51, 51); font-family: Monaco;"><b><font style="font-size: 14pt;">其他创建线程的手法</font></b></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco; background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（2.1）用类</b></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">class TA</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">{</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">public:</span></div><div><span style="font-size: 12pt; font-family: Monaco;">    <font color="#328712"><b>int &amp;m_i;<br/></b></font></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b>    TA(int &amp;i) : m_i(i){}</b></font><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><span>    void operator()()  //不能带参数</span><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><span>    {</span></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><span><span>    </span><span>    cout&lt;&lt;&quot;线程执行&quot;&lt;&lt;endl;</span><br/></span></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><span><span><span>    </span>}</span><br/></span></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">};</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">TA ta;</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">thread myxch(ta);  // ta：可调用对象</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">myxch.join();</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b>//注意（使用detach()时）：</b></font></span></div><div><span style="font-family: Monaco;"><font color="#328712"><b><span style="font-size: 12pt;">int i = 6; </span><font style="font-size: 12pt;"> </font></b></font></span><font color="#328712" style="font-size: 12pt;"><b>//引用过去，如果主线程结束，i被回收，这是线程就会出问题</b></font></div><div><span style="font-size: 12pt; font-family: Monaco;"><font style="color: rgb(50, 135, 18);"><b>TA ta(i);   //对象ta也是main（）中的局部对象，main()结束，ta也被析构了 </b></font></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b>thread myxch2(ta);  //主线程结束，ta没了，但是，这里是复制了一个对象到线程中</b></font></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>  //ta被销毁，但是复制的TA对象依旧存在</span><br/></b></font></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b><span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>    </span><span>     //所以，只要TA对象里没有引用，没有指针，就不会产生问题</span><br/></span></b></font></span></div><div><span style="font-size: 12pt; font-family: Monaco;"><font color="#328712"><b>myxch2.detach();</b></font></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco; background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（2.2）用lambda表达式</b></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">auto mylamthread = [] {cout&lt;&lt;&quot;线程开始&quot;&lt;&lt;endl;}</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">thread myxch3(mylamthread); </span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">myxch.join();</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div></span>
</div></body></html> 