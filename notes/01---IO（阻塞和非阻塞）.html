<html>
<head>
  <title>01---I/O（阻塞和非阻塞）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="825"/>
<h1>01---I/O（阻塞和非阻塞）</h1>

<div>
<span><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(227, 0, 0); font-weight: bold;">标准输入、输出</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image.png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">gcc  main.c   ---&gt;main.out</span></div><div><span style="font-size: 12pt;">在终端输入，然后在终端输出</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(227, 0, 0); font-weight: bold;">阻塞和非阻塞</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;color: rgb(51, 51, 51);font-family: Monaco;background-color: rgb(255, 250, 165);-evernote-highlight:true;">阻塞读终端</span></div><div><font style="font-size: 12pt;">#include &lt;unistd.h&gt; #include &lt;stdlib.h&gt;</font></div><div><font style="font-size: 12pt;">int main(void)</font></div><div><font style="font-size: 12pt;"> { </font></div><div><font style="font-size: 12pt;">    char buf[10]; </font></div><div><font style="font-size: 12pt;">    int n; </font></div><div><font style="font-size: 12pt;">    n = read(STDIN_FILENO, buf, 10);</font></div><div><font style="font-size: 12pt;">    if (n &lt; 0)</font></div><div><font style="font-size: 12pt;">     {</font></div><div><font style="font-size: 12pt;">         perror(&quot;read STDIN_FILENO&quot;);</font></div><div><font style="font-size: 12pt;">         exit(1);</font></div><div><font style="font-size: 12pt;">     } </font></div><div><font style="font-size: 12pt;">    write(STDOUT_FILENO, buf, n); return 0;</font></div><div><font style="font-size: 12pt;"> }</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;background-color: rgb(255, 250, 165);-evernote-highlight:true;">非阻塞读终端</font></div><div><font style="font-size: 12pt;">#include &lt;unistd.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;fcntl.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;errno.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;string.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;stdlib.h&gt;</font></div><div><font style="font-size: 12pt;">#define MSG_TRY &quot;try again\n&quot;</font></div><div><font style="font-size: 12pt;">int main(void)</font></div><div><font style="font-size: 12pt;"> { </font></div><div><font style="font-size: 12pt;">  char buf[10];</font></div><div><font style="font-size: 12pt;">  int fd, n;</font></div><div><font style="font-size: 12pt;">  <font color="#E30000">fd = open(&quot;/dev/tty&quot;, O_RDONLY|O_NONBLOCK); //把终端设置为非阻塞</font></font></div><div><font style="font-size: 12pt;">  if(fd&lt;0)</font></div><div><font style="font-size: 12pt;">  {  </font></div><div><font style="font-size: 12pt;">    perror(&quot;open /dev/tty&quot;); </font></div><div><font style="font-size: 12pt;">    exit(1);</font></div><div><font style="font-size: 12pt;">  } </font></div><div><font style="font-size: 12pt;">tryagain:</font></div><div><font style="font-size: 12pt;">     n = read(fd, buf, 10);</font></div><div><font style="font-size: 12pt;">     if (n &lt; 0)</font></div><div><font style="font-size: 12pt;">     { </font></div><div><font style="font-size: 12pt;">        if (<font color="#E30000">errno == EAGAIN</font>) </font></div><div><font style="font-size: 12pt;">        { </font></div><div><font style="font-size: 12pt;">            sleep(1); </font></div><div><font style="font-size: 12pt;">            write(STDOUT_FILENO, MSG_TRY, strlen(MSG_TRY));  //打印一段话</font></div><div><font style="font-size: 12pt;">            goto tryagain; </font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">       perror(&quot;read /dev/tty&quot;); </font></div><div><font style="font-size: 12pt;">       exit(1); </font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">     }</font></div><div><font style="font-size: 12pt;"> write(STDOUT_FILENO, buf, n);</font></div><div><font style="font-size: 12pt;"> close(fd); </font></div><div><font style="font-size: 12pt;"> return 0;</font></div><div><font style="font-size: 12pt;"> }</font></div></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">-----------------------------------------------------------------------------------------------------------------------------------------</span></font></div><div><span style="font-size: 12pt;">#include &lt;errno.h&gt;</span></div><div><span style="font-size: 12pt;">errno 会得到相应错误对应的值</span></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image [1].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">报错：<span style="font-size: 12pt; color: rgb(20, 113, 145);">xingwenpeng </span><span style="font-size: 12pt; color: rgb(20, 113, 145); font-weight: bold;">: </span><span style="font-size: 12pt; color: rgb(20, 113, 145);">错误原因</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">perror()    </font></div><div><font style="font-size: 12pt;">char* strerr(int errnum)   // #include &lt;string.h&gt;</font></div></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="01---IO（阻塞和非阻塞）_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 12pt;">报错：xwp </span><span style="font-size: 12pt; font-weight: bold;">: </span><span style="font-size: 12pt;">错误原因</span></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">--------------------------------------------------------------------------------------------------------------------------------------</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(227, 0, 0); font-weight: bold;">lseek</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">lseek和标准I/O库的fseek函数类似，可以移动当前读写位置（或者叫偏移量）</font></div><div><font style="font-size: 12pt;">off_t lseek(int fd, off_t offset, int whencd);  //whencd：当前位置(SEEK_SET/SEEK_CUR/SEEK_END)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font color="#147191" style="font-size: 12pt;">off_t currpos;</font></div><div><font color="#147191" style="font-size: 12pt;">currpos = lseek(fd, 0, SEEK_CUR);</font></div><div><font color="#FF7A74" style="font-size: 12pt;">lseek成功时<b>返回当前（新的）偏移量</b>失败时返回-1</font></div><div><font style="font-size: 12pt;">这种方法也可用来确定文件或设备是否可以设置偏移量，常规文件都可以设置偏移量，</font></div><div><font style="font-size: 12pt;">而设备一般是不可以设置偏移量的。</font><span style="font-size: 12pt;">如果设备不支持lseek，则lseek返回-1，并将errno 设置为ESPIPE。</span></div></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image [3].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">abc文件大小为：4097</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(20, 113, 145); font-weight: bold;">用lseek返回一个文件的大小</span></span></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image [4].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(227, 0, 0); font-weight: bold;">fcntl</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">先前我们以read终端设备为例介绍了非阻塞I/O，为什么我们不直接对STDIN_FILENO做非阻塞read，</font></div><div><font style="font-size: 12pt;">而要重新open一遍/dev/tty呢？</font></div><div><font style="font-size: 12pt;">因为STDIN_FILENO在程序启动时已经被自动 打开了，而我们需要在调用open时指定O_NONBLOCK标志</font><span style="font-size: 12pt;">。</span></div><div><span style="font-size: 12pt;"><b>这里介绍另外一种办法，可以用 fcntl函数改变一个已打开的文件的属性，</b></span></div><div><font style="font-size: 12pt;"><b>可以重新设置读、写、追加、非阻塞等标志（这 些标志称为File Status Flag），而不必重新open文件。</b></font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">#include &lt;unistd.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;fcntl.h&gt;</font></div><div><font style="font-size: 12pt;">int fcntl(int fd, int cmd);</font></div><div><font style="font-size: 12pt;">int fcntl(int fd, int cmd, long arg); </font></div><div><font style="font-size: 12pt;">int fcntl(int fd, int cmd, struct flock *lock);</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">用fcntl改变File Status Flag</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">#include &lt;unistd.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;fcntl.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;errno.h&gt;</font></div><div><font style="font-size: 12pt;">#include &lt;string.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;stdlib.h&gt;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">#define MSG_TRY &quot;try again\n&quot;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">int main(void) </font></div><div><font style="font-size: 12pt;">{ </font></div><div><font style="font-size: 12pt;">    char buf[10]; </font></div><div><font style="font-size: 12pt;">    int n; </font></div><div><font style="font-size: 12pt;">    int flags; </font></div><div><font style="font-size: 12pt;">    flags = <font color="#E30000">fcntl(STDIN_FILENO, F_GETFL)</font>;    //获取一个标志(<font color="#E30000">访问控制属性</font>)给flags</font></div><div><font style="font-size: 12pt;">    flags |= O_NONBLOCK;     //或一个非阻塞</font></div><div><font style="font-size: 12pt;">    if (<font color="#E30000">fcntl(STDIN_FILENO, F_SETFL, flags)</font> == -1)    //设置成flags</font></div><div><font style="font-size: 12pt;">     { </font></div><div><font style="font-size: 12pt;">        perror(&quot;fcntl&quot;); </font></div><div><font style="font-size: 12pt;">        exit(1); </font></div><div><font style="font-size: 12pt;">      } </font></div><div><font style="font-size: 12pt;">tryagain: </font></div><div><font style="font-size: 12pt;">    n = read(STDIN_FILENO, buf, 10); </font></div><div><font style="font-size: 12pt;">    if (n &lt; 0) </font></div><div><font style="font-size: 12pt;">    { </font></div><div><font style="font-size: 12pt;">        if (errno == EAGAIN) </font></div><div><font style="font-size: 12pt;">        { </font></div><div><font style="font-size: 12pt;">        sleep(1); </font></div><div><font style="font-size: 12pt;">        write(STDOUT_FILENO, MSG_TRY, strlen(MSG_TRY));</font></div><div><font style="font-size: 12pt;">         goto tryagain; </font></div><div><font style="font-size: 12pt;">        }</font></div><div><br/></div><div><font style="font-size: 12pt;">        perror(&quot;read stdin&quot;);</font></div><div><font style="font-size: 12pt;">        exit(1); </font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">     write(STDOUT_FILENO, buf, n);</font></div><div><font style="font-size: 12pt;">     return 0; </font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image [5].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 14pt; color: rgb(227, 0, 0);"><b>ioctl</b></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">ioctl用于向设备发控制和配置命令，有些命令也需要读写一些数据，但这些数据是 不能用read/write读写的，称为Out-of-band数据。</font></div><div><font style="font-size: 12pt;">也就是说，read/write读写的数据是 in-band数据，是I/O操作的主体，而ioctl命令传送的是控制信息，其中的数据是辅助的数据。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><b>例如</b>，在串口线上收发数据通过read/write操作，而串口的波特率、校验位、停止位通 过ioctl设置，</font></div><div><font style="font-size: 12pt;">A/D转换的结果通过read读取，而A/D转换的精度和工作频率通过ioctl设置。</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">#include &lt;sys/ioctl.h&gt;</font></div><div><font style="font-size: 12pt;">int ioctl(int d, int request, ...);</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;"><img src="01---IO（阻塞和非阻塞）_files/Image [6].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">#include &lt;stdio.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;stdlib.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;unistd.h&gt; </font></div><div><font style="font-size: 12pt;">#include &lt;sys/ioctl.h&gt;</font></div><div><font style="font-size: 12pt;">int main(void) </font></div><div><font style="font-size: 12pt;">{ </font></div><div><font style="font-size: 12pt;"><span>    </span>struct winsize size;   //终端大小</font></div><div><font style="font-size: 12pt;"><span>    </span>if (isatty(STDOUT_FILENO) == 0)    //判断是否是一个终端文件</font></div><div><font style="font-size: 12pt;"><span>    </span><span>    </span>exit(1); </font></div><div><font style="font-size: 12pt;"><span>    </span>if(<font color="#E30000">ioctl(STDOUT_FILENO, TIOCGWINSZ, &amp;size)</font>&lt;0)   //获取终端窗口大小，存放到size </font></div><div><font style="font-size: 12pt;"><span>    </span>{ </font></div><div><font style="font-size: 12pt;"><span>    </span><span>    </span>perror(&quot;ioctl TIOCGWINSZ error&quot;); </font></div><div><font style="font-size: 12pt;"><span>    </span><span>    </span>exit(1); </font></div><div><font style="font-size: 12pt;"><span>    </span>} </font></div><div><font style="font-size: 12pt;"><span>    </span>printf(&quot;%d rows, %d columns\n&quot;, <font color="#E30000">size.ws_row, size.ws_col</font>);    </font></div><div><font style="font-size: 12pt;"><span>    </span>return 0; </font></div><div><font style="font-size: 12pt;">}</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div></span>
</div></body></html> 