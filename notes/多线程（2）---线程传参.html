<html>
<head>
  <title>多线程（2）---线程传参</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601935 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="528"/>
<h1>多线程（2）---线程传参</h1>

<div>
<span><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(173, 0, 0); font-weight: bold;">一、传递临时对象作为线程参数</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">void myprint(const int&amp;i, char *pmybuf)</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;i&lt;&lt;endl;  //<font color="#E30000">i并不是mvar的引用，实际是值传递</font></font></div><div><font style="font-size: 12pt;"><font color="#E30000">                      即使主线程detach了子线程，子线程也能正常运行</font></font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;pmybuf&lt;&lt;endl; //<font color="#E30000">指针不是复制，所以不安全</font></font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">改为：</font></div><div><font style="font-size: 12pt;">void myprint(const int &amp;i, <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">const string &amp;pmybuf</span>)</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">int main()</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    int mvar = 1;</font></div><div><font style="font-size: 12pt;">    int &amp;mvary = mvar;</font></div><div><font style="font-size: 12pt;">    char mybuf[] = &quot;this is a test!&quot;;</font></div><div><font style="font-size: 12pt;">    thread myxch(myprint,mvar,mybuf);  //<font color="#E30000">虽然是引用，但这里会复制mvar给i</font></font></div><div><font style="font-size: 12pt;">    myxch.join();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    //<b>myxch.detach();</b></font></div><div><font style="font-size: 12pt;">    </font></div><div><font style="font-size: 12pt;">    return 0;</font></div><div><font style="font-size: 12pt;">}</font></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;color: rgb(51, 51, 51);font-family: Monaco;background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（1.1）要避免的陷阱</b></span></div><div><font style="font-size: 12pt;">void myprint(<font color="#E30000">const int i, const string &amp;pmybuf</font>) //指针改为&amp;</font></div><div><font style="font-size: 12pt;">{</font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;i&lt;&lt;endl;  </font></div><div><font style="font-size: 12pt;">    cout&lt;&lt;pmybuf&lt;&lt;endl; </font></div><div><font style="font-size: 12pt;">}</font></div><div><span style="font-size: 12pt;color: rgb(51, 51, 51);font-family: Monaco;background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>（1.2）要避免的陷阱</b></span></div><div><font style="font-size: 12pt;">如果没使用detach()，隐式类型转换</font></div><div><font style="font-size: 12pt;">但使用之后：</font></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">mybuf都被回收了（main函数执行完了），系统才用mybuf去转string，但此时mybuf已经随着main的</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">结束而被回收了，所以这里直接用string(mybuf)，这是构造函数先执行，然后调用拷贝构造函数</span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">thread myxch( myprint , mvar ,</span> <span style="font-size: 12pt; font-family: Monaco;"><font color="#E30000">string(mybuf)</font></span> <span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">) ; // 最终修改，此时就算main()函数执行完，也没事</span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;"><b><font color="#E30000">类型转换构造函数</font></b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">class Complex{</font></div><div><font style="font-size: 12pt;">public:</font></div><div><font style="font-size: 12pt;">    double real, imag;</font></div><div><font style="font-size: 12pt;">    Complex(int i){  //类型转换构造函数</font></div><div><font style="font-size: 12pt;">        cout &lt;&lt; &quot;IntConstructor called&quot; &lt;&lt; endl;</font></div><div><font style="font-size: 12pt;">        real = i; imag = 0;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    Complex(double r, double i){</font></div><div><font style="font-size: 12pt;">        real = r;</font></div><div><font style="font-size: 12pt;">        imag = i;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">}；</font></div><div><font style="font-size: 12pt;">int main(){</font></div><div><font style="font-size: 12pt;">    Complex c1(7, 8);//调用普通构造函数</font></div><div><font style="font-size: 12pt;">    Complex c2 = 12;//等号是初始化，不是赋值，初始化过程中调用类型转换构造函数时</font></div><div><font style="font-size: 12pt;">                    //把12作为参数传给Complex（int i）函数</font></div><div><font style="font-size: 12pt;">    c1 = 9;         //9被自动转换成一个临时Complex对象</font></div><div><font style="font-size: 12pt;">          //这是一个赋值语句，直接能赋值，是因为编译器会自动调用类型转化构造函数</font></div><div><font style="font-size: 12pt;">    cout &lt;&lt; c1.real &lt;&lt; &quot;,&quot; &lt;&lt; c1.imag &lt;&lt; endl;</font></div><div><font style="font-size: 12pt;">    return 0;</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">输出：9,0</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div></span>
</div></body></html> 